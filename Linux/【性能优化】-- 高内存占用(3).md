### 概述

Linux 中内存的去向一般有 4 个：用户进程消耗、cache+buffer 消耗、Slab 消耗、PageTables 消耗。在 [高内存占用(1)](https://github.com/hsxhr-10/blog/blob/master/Linux/【性能优化】--%20高内存占用(1).md) 中着重讨论了用户进程消耗相关内容。

---

### <font color=#00b0f0>运行环境</font>

```
# uname -a
Linux ubuntu 3.16.0-30-generic #40~14.04.1-Ubuntu SMP Thu Jan 15 17:43:14 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux

# cat /etc/*-release
DISTRIB_DESCRIPTION="Ubuntu 14.04.2 LTS"

# 内存：2G
# CPU：2核
```

---

### 内存占用分析及解决

#### cache+buffer 消耗

cache/buffer 跟磁盘 I/O 子系统密切相关，特别是 Page Cache Layer 这一层，这些缓存主要是用在 Page Cache, inode cache, dentry cache。其存在可以极大提升磁盘 I/O 性能，具体细节可以参考 “【磁盘 IO】” 系列。特别的是，相对其他 3 种消耗，该消耗是可回收的，演示如下：

```
# 根据 free 命令发现 cache/buffer 的值是 3.6G 左右，比较大了
root@120:~# free -m
             total       used       free     shared    buffers     cached
Mem:         16047       4363      11683          0        275       3449
-/+ buffers/cache:        638      15408
Swap:            0          0          0

# 根据 slabtop 命令进一步发现用在 inode cache 大概是 164M，用在 dentry cache 大概是 52M
root@120:~# slabtop

 Active / Total Objects (% used)    : 1609328 / 1977155 (81.4%)
 Active / Total Slabs (% used)      : 58203 / 58203 (100.0%)
 Active / Total Caches (% used)     : 75 / 136 (55.1%)
 Active / Total Size (% used)       : 390640.94K / 429811.04K (90.9%)
 Minimum / Average / Maximum Object : 0.01K / 0.22K / 8.00K

  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   
273609 273436  99%    0.19K  13029       21     52116K dentry
153720 153690  99%    1.05K   5124       30    163968K ext4_inode_cache
...

# 通过向 /proc/sys/vm/drop_caches 文件输入 1 来清除 page cache，注意要先执行 sync 命令让缓存中的数据落盘，
# 可以看到 cached/buffer 中的 page cache 部分已经被回收了
root@120:~# sync
root@120:~# echo 1 > /proc/sys/vm/drop_caches
root@120:~# free -m
             total       used       free     shared    buffers     cached
Mem:         16047        609      15437          0          0        103
-/+ buffers/cache:        505      15541
Swap:            0          0          0

# 再次执行 slabtop 命令，看到 dentry cache 和 inode cache 没变
root@120:~# slabtop

 Active / Total Objects (% used)    : 738595 / 754305 (97.9%)
 Active / Total Slabs (% used)      : 26642 / 26642 (100.0%)
 Active / Total Caches (% used)     : 75 / 136 (55.1%)
 Active / Total Size (% used)       : 291837.69K / 295937.82K (98.6%)
 Minimum / Average / Maximum Object : 0.01K / 0.39K / 8.00K

  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   
273609 273496  99%    0.19K  13029       21     52116K dentry
153720 153690  99%    1.05K   5124       30    163968K ext4_inode_cache
...

# 通过向 /proc/sys/vm/drop_caches 文件输入 2 来清除 dentry cache 和 inode cache，注意提前 sync
root@120:~# sync
root@120:~# echo 2 > /proc/sys/vm/drop_caches

# 再次执行 slabtop 命令，看到 dentry cache 从 52M 变成 3M，inode cache 从 164M 变成 4M，都被回收了
root@120:~# slabtop

 Active / Total Objects (% used)    : 165139 / 198944 (83.0%)
 Active / Total Slabs (% used)      : 5624 / 5624 (100.0%)
 Active / Total Caches (% used)     : 75 / 136 (55.1%)
 Active / Total Size (% used)       : 32948.48K / 42575.39K (77.4%)
 Minimum / Average / Maximum Object : 0.01K / 0.21K / 8.00K

  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   
 18837  12983  68%    0.19K    897       21      3588K dentry
 ...
 4020   1049  26%    1.05K    134       30      4288K ext4_inode_cache
 ...

# 通过向 /proc/sys/vm/drop_caches 文件输入 3 来清除 dentry cache 和 inode cache 和 page cache，这里不演示了
```

> 一般情况下，cache/buffer 是不建议手动回收的，因为这样不利于系统的 I/O 性能。当 cache/buffer 的内存消耗已经影响到了业务进程的时候，更彻底的解决方法应该是加大内存容量或者调整服务进程

















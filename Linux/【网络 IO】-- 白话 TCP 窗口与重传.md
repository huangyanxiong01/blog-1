### 概述

TCP 层主要提供 3 个功能：有序传输、超时重传、流量控制。下面的讨论涉及到的就是重传和流控。

---

### TCP 窗口

TCP 窗口之间的关系：min(接收窗口，拥塞窗口) => 发送窗口，即接受方的接收窗口和发送方的拥塞窗口之间的小者，决定着发送方的发送窗口大小。重传和流控也是围绕着 **“在当前的接收窗口大小和网络环境条件下，发送窗口应该多大”** 这个主题的。

#### 接收窗口

1. 直观认识接收窗口

接收窗口是几个窗口中最简单的。接收窗口指的是接收方自身的接收缓存大小，是在 TCP 3 次握手中告知对方的一个信息。下图演示的就是 192.168.1.102 和 59.37.96.63 在 3 次握手中分别交换的接收窗口大小信息：

![](https://raw.githubusercontent.com/hsxhr-10/picture/master/客户端接收窗口.png)

![](https://raw.githubusercontent.com/hsxhr-10/picture/master/服务端接收窗口.png)


2. TCP Window Scale

在 TCP 刚被发明实现出来时，世界的网络带宽都很小，最大的接收窗口只有 65535B，也就差不多 65KB 大小。随着硬件的不断进步，65KB 早就成了性能瓶颈，由于 TCP 头留给接收窗口只有 16bit，所以最大也只能 2^16-1 个字节 (刚好就是65535B)。所以想在这个 TCP 头字段做文章是不可能了 (排除 IPv6)，幸好 TCP 头里面还有一个万能的 option 字段，因此在 option 字段中可以再通过 window scale 字段来扩展接收窗口的大小。如下图演示：

![](https://raw.githubusercontent.com/hsxhr-10/picture/master/WindowScale.png)

根据上图，192.168.1.102 的真实接收窗口大小应该是 65535 * 32 = 1706720B，大约 1.6MB。

3. 查看和调整接收窗口大小

```
# 查看接收窗口大小，三个数字分别是最小、默认、最大接收窗口大小
shell> cat /proc/sys/net/ipv4/tcp_rmem
4096	87380	6291456

# 调整接收窗口大小
shell> echo 1048576 1048576 1048576 > /proc/sys/net/ipv4/tcp_rmem
```

4. 接收窗口与发送窗口的关系

因为接收窗口和拥塞窗口共同决定着发送窗口，因此先做两个假设，来排除拥塞窗口的影响：1. 假设接收窗口非常小。原因是：这样拥塞窗口将很可能永远都不会触碰到拥塞点，接收窗口也成了影响发送窗口的最大因素了；2. 网络非常顺畅，拥塞窗口可以增长的大小远远大于接收窗口。

基于上面任意一个假设，当接收窗口减小时，发送窗口也会随着减小，这就是 TCP 的滑动窗口机制。

5. 一些实用建议

- 在网络环境很差的情况下，调小接收窗口可以提升性能
- 在网络环境良好的情况下，调大接收窗口可以提升性能
- 上面两点的前提和操作如果互换，将会产生反效果

> 当网络环境很差时 (比如频繁发生网络线路的拥塞)，调大接收窗口反而会让发送方频频触碰拥塞点，从而触发发送方的超时重传，发送方大部分时间也将处于慢启动过程中，严重影响网络 IO 性能。











